#!/bin/bash
# Area Desktop Session
# Single unified session script that waits for Area to be ready before launching apps

set +e  # Don't exit on errors - we want the session to keep running

# ============================================================================
# Environment Setup
# ============================================================================

# Robustness: Reset failed units from previous session
for unit in $(systemctl --user --no-legend --state=failed --plain list-units | cut -f1 -d' '); do
    partof="$(systemctl --user show -p PartOf --value "$unit")"
    for target in area-desktop.target graphical-session.target; do
        if [ "$partof" = "$target" ]; then
            systemctl --user reset-failed "$unit"
            break
        fi
    done
done

# Source /etc/profile for system-wide environment variables
if [ -f /etc/profile ]; then
    source /etc/profile
fi

# CRITICAL: Import environment from LightDM FIRST (before any modifications)
# LightDM sets DISPLAY, XAUTHORITY, XDG_RUNTIME_DIR, etc. via PAM
# We must preserve these exactly as LightDM set them - don't override!
systemctl --user import-environment

# Now verify and set defaults only if missing (don't override LightDM's values)
# Export runtime dir (LightDM sets this, but ensure it exists)
export XDG_RUNTIME_DIR="${XDG_RUNTIME_DIR:-/run/user/$(id -u)}"
mkdir -p "$XDG_RUNTIME_DIR"

# Set desktop environment identifiers
export XDG_CURRENT_DESKTOP=Area
export XDG_SESSION_TYPE=x11

# Ensure DISPLAY is set (LightDM should set this, but don't override if it exists)
if [ -z "$DISPLAY" ]; then
    echo "Warning: DISPLAY not set by LightDM, defaulting to :0" >&2
    export DISPLAY=:0
fi
# Always export DISPLAY to ensure it's available
export DISPLAY

# CRITICAL: XAUTHORITY handling - LightDM sets this via PAM
# We should NOT override it, only ensure it's exported and available
if [ -z "$XAUTHORITY" ]; then
    # LightDM didn't set it - try to find it (fallback for non-standard setups)
    if [ -f "$HOME/.Xauthority" ]; then
        export XAUTHORITY="$HOME/.Xauthority"
        echo "Found XAUTHORITY at $HOME/.Xauthority (fallback)"
    elif [ -f "/run/user/$(id -u)/gdm/Xauthority" ]; then
        export XAUTHORITY="/run/user/$(id -u)/gdm/Xauthority"
        echo "Found XAUTHORITY at /run/user/$(id -u)/gdm/Xauthority (fallback)"
    elif [ -f "/var/run/gdm3/$(id -u)/Xauthority" ]; then
        export XAUTHORITY="/var/run/gdm3/$(id -u)/Xauthority"
        echo "Found XAUTHORITY at /var/run/gdm3/$(id -u)/Xauthority (fallback)"
    else
        echo "ERROR: XAUTHORITY not set by LightDM and not found in fallback locations!" >&2
        echo "  This will cause X11 applications to fail." >&2
        echo "  Check your LightDM PAM configuration (should include pam_env.so)" >&2
    fi
else
    # LightDM set it - use it exactly as provided
    export XAUTHORITY
    echo "Using XAUTHORITY from LightDM: $XAUTHORITY"
fi

# Add navigator development path to PATH
if [ -d "$HOME/GitHub/xfce-rs/target/release" ]; then
    export PATH="$HOME/GitHub/xfce-rs/target/release:$PATH"
elif [ -d "$HOME/GitHub/xfce-rs/navigator/target/release" ]; then
    export PATH="$HOME/GitHub/xfce-rs/navigator/target/release:$PATH"
fi

# CRITICAL: Set environment variables in systemd AFTER we've ensured they're correct
# This ensures systemd services inherit the correct values from LightDM
if [ -n "$DISPLAY" ]; then
    systemctl --user set-environment "DISPLAY=$DISPLAY"
fi

if [ -n "$XAUTHORITY" ]; then
    systemctl --user set-environment "XAUTHORITY=$XAUTHORITY"
    echo "Set XAUTHORITY in systemd environment: $XAUTHORITY"
else
    echo "ERROR: Cannot proceed without XAUTHORITY!" >&2
    echo "  LightDM should set this automatically via PAM." >&2
    echo "  Check your LightDM PAM configuration (should include pam_env.so)" >&2
    exit 1
fi

# Also set other important variables for systemd services
systemctl --user set-environment "XDG_RUNTIME_DIR=$XDG_RUNTIME_DIR"
systemctl --user set-environment "XDG_CURRENT_DESKTOP=Area"
systemctl --user set-environment "XDG_SESSION_TYPE=x11"

# Save environment variables that will be added to systemd (for cleanup later)
new_env=$(systemctl --user show-environment | cut -d'=' -f 1 | sort | comm -13 - <(env | cut -d'=' -f 1 | sort))

# Ensure systemd user services directory exists
SYSTEMD_USER_DIR="$HOME/.config/systemd/user"
mkdir -p "$SYSTEMD_USER_DIR"

# Check if area.service exists
if [ ! -f "$SYSTEMD_USER_DIR/area.service" ]; then
    echo "Error: area.service not found. Run install script first." >&2
    exit 1
fi

# Reload systemd user daemon to pick up any new service files
systemctl --user daemon-reload

# ============================================================================
# Start Area WM+Compositor
# ============================================================================

echo "Starting Area WM+Compositor..."

# Verify XAUTHORITY is set in systemd environment before starting service
if ! systemctl --user show-environment 2>/dev/null | grep -q "^XAUTHORITY="; then
    echo "ERROR: XAUTHORITY not set in systemd environment!" >&2
    echo "  This will cause Area to fail with 'Authorization required' error." >&2
    echo "  Attempting to set it now..." >&2
    if [ -n "$XAUTHORITY" ]; then
        systemctl --user set-environment "XAUTHORITY=$XAUTHORITY"
        echo "  Set XAUTHORITY=$XAUTHORITY"
    else
        echo "  FATAL: Cannot proceed without XAUTHORITY" >&2
        exit 1
    fi
fi

# Enable and start the desktop target
systemctl --user enable area-desktop.target
systemctl --wait --user start area-desktop.target

# ============================================================================
# Wait for Area Ready Signal
# ============================================================================

echo "Waiting for Area WM+Compositor to be ready..."

READY_FILE="${XDG_RUNTIME_DIR}/area-ready"
MAX_WAIT=30  # Maximum seconds to wait
elapsed=0

# Wait for service to be active first
while ! systemctl --user is-active --quiet area.service && [ $elapsed -lt 10 ]; do
    sleep 0.2
    elapsed=$((elapsed + 1))
done

if ! systemctl --user is-active --quiet area.service; then
    echo "Warning: area.service did not become active within 10s" >&2
fi

# Wait for ready signal file
elapsed=0
while [ ! -f "$READY_FILE" ] && [ $elapsed -lt $MAX_WAIT ]; do
    sleep 0.5
    elapsed=$((elapsed + 1))
    if [ $((elapsed % 2)) -eq 0 ]; then
        echo "  Still waiting... (${elapsed}s/${MAX_WAIT}s)"
    fi
done

if [ -f "$READY_FILE" ]; then
    echo "✓ Area WM+Compositor is ready!"
    rm -f "$READY_FILE"  # Clean up
else
    echo "Warning: Area ready signal not received within ${MAX_WAIT}s, proceeding anyway..." >&2
fi

# Small delay to ensure everything is settled
sleep 0.5

# ============================================================================
# Launch Applications (only after Area is ready)
# ============================================================================

echo ""
echo "Launching applications..."

# Single unified launch function - handles desktop files and commands
launch_app() {
    local app_name="$1"
    local app_id_or_command="$2"
    shift 2
    local app_args="$@"
    
    local log_file="${XDG_RUNTIME_DIR:-/tmp}/${app_name}.log"
    
    # Try desktop file first (proper way)
    if command -v xdg-open >/dev/null 2>&1; then
        for dir in "$HOME/.local/share/applications" "/usr/share/applications"; do
            if [ -f "$dir/${app_id_or_command}.desktop" ]; then
                echo "  → $app_name"
                # Log errors to file for debugging, but don't block
                DISPLAY="$DISPLAY" XAUTHORITY="$XAUTHORITY" xdg-open "$dir/${app_id_or_command}.desktop" >"$log_file" 2>&1 &
                local app_pid=$!
                # Check if it's still running after a short delay
                sleep 0.3
                if ! kill -0 "$app_pid" 2>/dev/null; then
                    echo "    ⚠ Failed to launch $app_name - check $log_file for errors" >&2
                    return 1
                fi
                return 0
            fi
        done
    fi
    
    # Fallback: try gtk-launch
    if command -v gtk-launch >/dev/null 2>&1; then
        if [ -f "$HOME/.local/share/applications/${app_id_or_command}.desktop" ] || \
           [ -f "/usr/share/applications/${app_id_or_command}.desktop" ]; then
            echo "  → $app_name"
            DISPLAY="$DISPLAY" XAUTHORITY="$XAUTHORITY" gtk-launch "$app_id_or_command" "$@" >"$log_file" 2>&1 &
            local app_pid=$!
            sleep 0.3
            if ! kill -0 "$app_pid" 2>/dev/null; then
                echo "    ⚠ Failed to launch $app_name - check $log_file for errors" >&2
                return 1
            fi
            return 0
        fi
    fi
    
    # Last resort: direct command launch
    if command -v "$app_id_or_command" >/dev/null 2>&1; then
        echo "  → $app_name"
        DISPLAY="$DISPLAY" XAUTHORITY="$XAUTHORITY" "$app_id_or_command" $app_args >"$log_file" 2>&1 &
        local app_pid=$!
        sleep 0.3
        if ! kill -0 "$app_pid" 2>/dev/null; then
            echo "    ⚠ Failed to launch $app_name - check $log_file for errors" >&2
            return 1
        fi
        return 0
    fi
    
    echo "    ⚠ $app_name not found (command: $app_id_or_command)" >&2
    return 1
}

# Launch terminal (xfce4-terminal)
if ! launch_app "xfce4-terminal" "xfce4-terminal"; then
    launch_app "alacritty" "alacritty" || \
    launch_app "xterm" "xterm"
fi

sleep 0.5

# Launch navigator (application launcher)
NAVIGATOR_BIN=""
if command -v navigator >/dev/null 2>&1; then
    NAVIGATOR_BIN="$(command -v navigator)"
elif [ -f "$HOME/.local/bin/navigator" ]; then
    NAVIGATOR_BIN="$HOME/.local/bin/navigator"
elif [ -f "/usr/local/bin/navigator" ]; then
    NAVIGATOR_BIN="/usr/local/bin/navigator"
elif [ -f "$HOME/GitHub/xfce-rs/target/release/navigator" ]; then
    NAVIGATOR_BIN="$HOME/GitHub/xfce-rs/target/release/navigator"
elif [ -f "$HOME/GitHub/xfce-rs/navigator/target/release/navigator" ]; then
    NAVIGATOR_BIN="$HOME/GitHub/xfce-rs/navigator/target/release/navigator"
fi

if [ -n "$NAVIGATOR_BIN" ] && [ -x "$NAVIGATOR_BIN" ]; then
    echo "  → navigator"
    DISPLAY="$DISPLAY" XAUTHORITY="$XAUTHORITY" "$NAVIGATOR_BIN" > "${XDG_RUNTIME_DIR}/navigator.log" 2>&1 &
fi

sleep 0.5

# Launch area-focus if available
if command -v area-focus >/dev/null 2>&1; then
    echo "  → area-focus"
    DISPLAY="$DISPLAY" XAUTHORITY="$XAUTHORITY" area-focus > "${XDG_RUNTIME_DIR}/area-focus.log" 2>&1 &
elif [ -f "$HOME/.local/bin/area-focus" ]; then
    echo "  → area-focus"
    DISPLAY="$DISPLAY" XAUTHORITY="$XAUTHORITY" "$HOME/.local/bin/area-focus" > "${XDG_RUNTIME_DIR}/area-focus.log" 2>&1 &
fi

# ============================================================================
# ADD YOUR STARTUP APPLICATIONS HERE
# ============================================================================
# Use the launch_app helper function to add more applications:
#
#   launch_app "app-name" "command" [args...]
#
# Examples:
#   launch_app "chromium" "chromium"
#   launch_app "firefox" "firefox" "--new-window"
#   launch_app "thunar" "thunar"
#   launch_app "gedit" "gedit" "/path/to/file.txt"
#
# The launch_app function automatically:
#   - Checks if the command exists
#   - Sets DISPLAY and XAUTHORITY
#   - Launches in background
#   - Returns 0 on success, 1 on failure
#
# You can also launch apps directly:
#   DISPLAY="$DISPLAY" XAUTHORITY="$XAUTHORITY" your-app >/dev/null 2>&1 &
# ============================================================================

echo ""
echo "✓ Area desktop session started. Applications launched."

# ============================================================================
# Keep Session Running
# ============================================================================

# Keep the session running - wait for area-desktop.target to stop
while systemctl --user is-active --quiet area-desktop.target; do
    sleep 1
done

echo "Area desktop session ending..."

# Cleanup: Unset environment variables that we added
systemctl --user unset-environment $new_env
